# üìß Sistema de Notifica√ß√µes por Email - Documenta√ß√£o Completa

## üîß Configura√ß√£o Necess√°ria

### 1. Configurar Gmail com Senha de Aplicativo

1. **Acesse sua conta do Google**
2. **V√° para Seguran√ßa da Conta**: https://myaccount.google.com/security
3. **Ative a Verifica√ß√£o em Duas Etapas** (se n√£o estiver ativada)
4. **Gere uma Senha de Aplicativo**:
   - V√° em "Senhas de aplicativo"
   - Selecione "Email" e "Outro (nome personalizado)"
   - Digite "Sistema de Agendamento"
   - Copie a senha gerada (16 caracteres)

### 2. Configurar Vari√°veis de Ambiente

Edite o arquivo `backend/config.env`:

```env
# Configura√ß√£o de Email SMTP Gmail
SMTP_EMAIL=seu-email@gmail.com
SMTP_PASSWORD=sua-senha-de-aplicativo-de-16-caracteres
```

### 3. Instalar Depend√™ncias

```bash
cd backend
npm install
```

## üìã TODOS OS CASOS DE ENVIO DE EMAIL

### üîÑ **FLUXO DE RESERVAS DE ESPA√áOS**

#### **1. üìù Cria√ß√£o de Nova Reserva**
**Arquivo:** `backend/pages/api/reservations/index.js` (POST)
**Trigger:** Aluno cria uma nova reserva

**Cen√°rios de Envio:**

##### **1.1. Reserva com Professor Respons√°vel**
- **Para quem:** Professor respons√°vel pelo projeto
- **Quando:** Status inicial = `pending` E projeto tem professor
- **Template:** `newReservationForProfessor`
- **Conte√∫do:**
  - Nome do evento
  - Nome do aluno
  - Sala solicitada
  - Data e hor√°rio
  - Nome do projeto
  - Descri√ß√£o (se houver)
  - Mensagem: "Nova reserva pendente que precisa de sua aprova√ß√£o"

##### **1.2. Reserva sem Professor Respons√°vel**
- **Para quem:** Administrador do sistema
- **Quando:** Status inicial = `pending` E projeto N√ÉO tem professor
- **Template:** `newReservationForAdmin`
- **Conte√∫do:**
  - Nome do evento
  - Nome do aluno
  - Sala solicitada
  - Data e hor√°rio
  - Nome do projeto
  - Descri√ß√£o (se houver)
  - Mensagem: "Nova reserva pendente para aprova√ß√£o administrativa"

##### **1.3. Reserva Aprovada Automaticamente**
- **Para quem:** Ningu√©m (n√£o envia email)
- **Quando:** Status inicial = `approved` (admin/coordenador criou)
- **Motivo:** J√° est√° aprovada, n√£o precisa de notifica√ß√£o

#### **2. ‚úÖ Aprova√ß√£o de Reserva pelo Professor**
**Arquivo:** `backend/pages/api/reservations/approve.js` (POST)
**Trigger:** Professor aprova uma reserva pendente

**Cen√°rios de Envio:**

##### **2.1. Notifica√ß√£o para o Aluno**
- **Para quem:** Aluno que fez a reserva
- **Quando:** Professor aprova (action = 'approve')
- **Template:** `reservationStatusUpdate`
- **Status:** `professor_approved`
- **Conte√∫do:**
  - Nome do evento
  - Sala
  - Data e hor√°rio
  - Status: "APROVADA PELO PROFESSOR"
  - Mensagem: "Sua reserva foi aprovada pelo professor e enviada para aprova√ß√£o final"

##### **2.2. Notifica√ß√£o para o Admin**
- **Para quem:** Administrador do sistema
- **Quando:** Professor aprova (action = 'approve')
- **Template:** `newReservationForAdmin`
- **Conte√∫do:**
  - Nome do evento
  - Nome do aluno
  - Sala
  - Data e hor√°rio
  - Nome do projeto
  - Nome do professor que aprovou
  - Mensagem: "Reserva aprovada pelo professor, precisa de aprova√ß√£o final"

#### **3. ‚úÖ Aprova√ß√£o Final pelo Admin**
**Arquivo:** `backend/pages/api/reservations/approve.js` (POST)
**Trigger:** Admin aprova uma reserva `professor_approved`

**Cen√°rio de Envio:**

##### **3.1. Notifica√ß√£o para o Aluno**
- **Para quem:** Aluno que fez a reserva
- **Quando:** Admin aprova (action = 'approve' E status anterior = 'professor_approved')
- **Template:** `reservationStatusUpdate`
- **Status:** `approved`
- **Conte√∫do:**
  - Nome do evento
  - Sala
  - Data e hor√°rio
  - Status: "APROVADA"
  - Mensagem: "Sua reserva foi confirmada! Voc√™ pode usar o espa√ßo no hor√°rio agendado"

#### **4. ‚ùå Rejei√ß√£o de Reserva**
**Arquivo:** `backend/pages/api/reservations/approve.js` (POST)
**Trigger:** Professor ou Admin rejeita uma reserva

**Cen√°rio de Envio:**

##### **4.1. Notifica√ß√£o para o Aluno**
- **Para quem:** Aluno que fez a reserva
- **Quando:** Professor ou Admin rejeita (action = 'reject')
- **Template:** `reservationStatusUpdate`
- **Status:** `rejected`
- **Conte√∫do:**
  - Nome do evento
  - Sala
  - Data e hor√°rio
  - Status: "REJEITADA"
  - Motivo da rejei√ß√£o (se fornecido)
  - Mensagem: "Sua reserva foi rejeitada. Entre em contato com a administra√ß√£o se tiver d√∫vidas"

### üë• **FLUXO DE SOLICITA√á√ïES DE PROJETO**

#### **5. üìù Nova Solicita√ß√£o de Projeto**
**Arquivo:** `backend/pages/api/projects/requests.js` (POST)
**Trigger:** Aluno solicita entrada em um projeto

**Cen√°rio de Envio:**

##### **5.1. Notifica√ß√£o para o Professor**
- **Para quem:** Professor respons√°vel pelo projeto
- **Quando:** Aluno cria solicita√ß√£o (status = 'pending')
- **Template:** `newProjectRequest`
- **Conte√∫do:**
  - Nome do projeto
  - Tipo do projeto
  - Nome do aluno
  - Email do aluno
  - Matr√≠cula do aluno
  - Mensagem do aluno (se houver)
  - Mensagem: "Nova solicita√ß√£o de entrada em seu projeto"

#### **6. ‚úÖ/‚ùå Processamento da Solicita√ß√£o**
**Arquivo:** `backend/pages/api/projects/requests.js` (PUT)
**Trigger:** Professor aprova ou rejeita solicita√ß√£o

**Cen√°rios de Envio:**

##### **6.1. Aprova√ß√£o da Solicita√ß√£o**
- **Para quem:** Aluno que fez a solicita√ß√£o
- **Quando:** Professor aprova (action = 'approved')
- **Template:** `projectRequestStatusUpdate`
- **Status:** `approved`
- **Conte√∫do:**
  - Nome do projeto
  - Tipo do projeto
  - Nome do professor
  - Status: "APROVADA"
  - Mensagem: "Parab√©ns! Voc√™ foi aceito no projeto e j√° pode fazer reservas de espa√ßos"

##### **6.2. Rejei√ß√£o da Solicita√ß√£o**
- **Para quem:** Aluno que fez a solicita√ß√£o
- **Quando:** Professor rejeita (action = 'rejected')
- **Template:** `projectRequestStatusUpdate`
- **Status:** `rejected`
- **Conte√∫do:**
  - Nome do projeto
  - Tipo do projeto
  - Nome do professor
  - Status: "REJEITADA"
  - Mensagem: "Sua solicita√ß√£o foi rejeitada. Entre em contato com o professor se tiver d√∫vidas"

## üö´ **CASOS QUE N√ÉO ENVIAM EMAIL**

### **Reservas:**
- ‚ùå Admin/Coordenador cria reserva (j√° aprovada automaticamente)
- ‚ùå Reserva cancelada pelo pr√≥prio usu√°rio
- ‚ùå Atualiza√ß√£o de dados da reserva (sem mudan√ßa de status)

### **Projetos:**
- ‚ùå Cria√ß√£o de projeto
- ‚ùå Atualiza√ß√£o de dados do projeto
- ‚ùå Remo√ß√£o de aluno do projeto

### **Usu√°rios:**
- ‚ùå Cria√ß√£o de conta
- ‚ùå Login/Logout
- ‚ùå Atualiza√ß√£o de perfil
- ‚ùå Recupera√ß√£o de senha

## üìä **RESUMO DE NOTIFICA√á√ïES**

| **A√ß√£o** | **Quem Recebe** | **Template** | **Frequ√™ncia** |
|----------|-----------------|--------------|----------------|
| Nova Reserva (com professor) | Professor | newReservationForProfessor | Sempre |
| Nova Reserva (sem professor) | Admin | newReservationForAdmin | Sempre |
| Professor Aprova | Aluno + Admin | reservationStatusUpdate + newReservationForAdmin | Sempre |
| Admin Aprova Final | Aluno | reservationStatusUpdate | Sempre |
| Reserva Rejeitada | Aluno | reservationStatusUpdate | Sempre |
| Nova Solicita√ß√£o Projeto | Professor | newProjectRequest | Sempre |
| Solicita√ß√£o Aprovada | Aluno | projectRequestStatusUpdate | Sempre |
| Solicita√ß√£o Rejeitada | Aluno | projectRequestStatusUpdate | Sempre |

## üîç **DETALHES T√âCNICOS**

### **Arquivos Modificados:**
- `backend/lib/emailService.js` - Servi√ßo principal de email
- `backend/pages/api/reservations/index.js` - Cria√ß√£o de reservas
- `backend/pages/api/reservations/approve.js` - Aprova√ß√£o/rejei√ß√£o de reservas
- `backend/pages/api/projects/requests.js` - Solicita√ß√µes de projeto

### **Tratamento de Erros:**
- ‚úÖ Emails falham silenciosamente (n√£o quebram o sistema)
- ‚úÖ Logs detalhados no console do servidor
- ‚úÖ Opera√ß√µes principais continuam mesmo com erro de email

### **Performance:**
- ‚úÖ Emails enviados de forma ass√≠ncrona
- ‚úÖ N√£o bloqueia resposta da API
- ‚úÖ Timeout configurado para evitar travamentos

## üé® **TEMPLATES DE EMAIL**

### **Caracter√≠sticas dos Templates:**
- ‚úÖ **Design responsivo** com cores e √≠cones
- ‚úÖ **Informa√ß√µes completas** da reserva/solicita√ß√£o
- ‚úÖ **Status visual** (aprovado/rejeitado)
- ‚úÖ **Motivos de rejei√ß√£o** quando aplic√°vel
- ‚úÖ **Instru√ß√µes claras** para o usu√°rio
- ‚úÖ **Formata√ß√£o HTML** profissional
- ‚úÖ **Vers√£o texto** para compatibilidade

### **Cores por Status:**
- üü¢ **Aprovado**: Verde (#059669)
- üî¥ **Rejeitado**: Vermelho (#dc2626)
- üü° **Pendente**: Amarelo (#d97706)
- üîµ **Notifica√ß√£o**: Azul (#2563eb)
- üü£ **Projeto**: Roxo (#7c3aed)

## üöÄ **COMO TESTAR O SISTEMA**

### **Teste 1: Nova Reserva**
1. **Fa√ßa login como aluno**
2. **Crie uma nova reserva** para um projeto com professor
3. **Verifique se o professor recebeu o email**
4. **Aprove a reserva como professor**
5. **Verifique se o aluno e admin receberam emails**

### **Teste 2: Solicita√ß√£o de Projeto**
1. **Fa√ßa login como aluno**
2. **Solicite entrada em um projeto**
3. **Verifique se o professor recebeu o email**
4. **Aprove/rejeite como professor**
5. **Verifique se o aluno recebeu o email**

### **Teste 3: Reserva sem Professor**
1. **Crie uma reserva** para projeto sem professor
2. **Verifique se o admin recebeu o email**

## üìã **EXEMPLOS PR√ÅTICOS**

### **Exemplo 1: Fluxo Completo de Reserva**
```
1. Aluno Jo√£o cria reserva "Reuni√£o de Projeto" para sala A1
   ‚Üí Email enviado para Professor Maria

2. Professor Maria aprova a reserva
   ‚Üí Email enviado para Aluno Jo√£o: "Aprovada pelo professor"
   ‚Üí Email enviado para Admin: "Precisa de aprova√ß√£o final"

3. Admin aprova a reserva
   ‚Üí Email enviado para Aluno Jo√£o: "Reserva confirmada!"
```

### **Exemplo 2: Rejei√ß√£o de Reserva**
```
1. Aluno Pedro cria reserva "Evento" para sala B2
   ‚Üí Email enviado para Professor Ana

2. Professor Ana rejeita com motivo "Sala indispon√≠vel"
   ‚Üí Email enviado para Aluno Pedro: "Reserva rejeitada - Sala indispon√≠vel"
```

### **Exemplo 3: Solicita√ß√£o de Projeto**
```
1. Aluno Carlos solicita entrada no "Projeto de IA"
   ‚Üí Email enviado para Professor Roberto

2. Professor Roberto aprova a solicita√ß√£o
   ‚Üí Email enviado para Aluno Carlos: "Aceito no projeto!"
```

## ‚ö†Ô∏è **TROUBLESHOOTING DETALHADO**

### **üîê Erro de Autentica√ß√£o**
**Sintomas:**
- Erro: "Invalid login: 535-5.7.8 Username and Password not accepted"
- Log: "Erro ao enviar email: Authentication failed"

**Solu√ß√µes:**
1. ‚úÖ Verifique se a senha de aplicativo est√° correta (16 caracteres)
2. ‚úÖ Confirme que a verifica√ß√£o em duas etapas est√° ativada
3. ‚úÖ Gere uma nova senha de aplicativo
4. ‚úÖ Teste com um email diferente se necess√°rio

### **üìß Emails n√£o chegam**
**Sintomas:**
- Log mostra "Email enviado com sucesso" mas n√£o chega
- Sem erros no console

**Solu√ß√µes:**
1. ‚úÖ Verifique a pasta de spam/lixo eletr√¥nico
2. ‚úÖ Confirme se o email de destino est√° correto
3. ‚úÖ Teste enviando para seu pr√≥prio email
4. ‚úÖ Verifique se o Gmail n√£o est√° bloqueando

### **üåê Erro de Conex√£o SMTP**
**Sintomas:**
- Erro: "ECONNREFUSED" ou "ETIMEDOUT"
- Log: "Erro ao enviar email: Connection failed"

**Solu√ß√µes:**
1. ‚úÖ Verifique a conex√£o com a internet
2. ‚úÖ Confirme se o Gmail n√£o bloqueou o acesso
3. ‚úÖ Teste com outro provedor SMTP se necess√°rio
4. ‚úÖ Verifique firewall/proxy da rede

### **üìù Erro de Template**
**Sintomas:**
- Erro: "Cannot read property of undefined"
- Log: "Erro ao enviar email: Template error"

**Solu√ß√µes:**
1. ‚úÖ Verifique se todos os dados necess√°rios est√£o sendo passados
2. ‚úÖ Confirme se as vari√°veis do template est√£o corretas
3. ‚úÖ Teste com dados m√≠nimos primeiro

## üìä **MONITORAMENTO E LOGS**

### **Logs de Sucesso:**
```
‚úÖ Email enviado com sucesso: <messageId@domain.com>
‚úÖ Notifica√ß√£o enviada para professor@email.com
‚úÖ Template: newReservationForProfessor
```

### **Logs de Erro:**
```
‚ùå Erro ao enviar email: Authentication failed
‚ùå Erro ao enviar email: Connection timeout
‚ùå Erro ao enviar email: Template error - missing data
```

### **Como Monitorar:**
1. **Console do servidor** - Logs em tempo real
2. **Arquivo de log** - Se configurado
3. **Dashboard de email** - Gmail/Google Workspace
4. **Testes manuais** - Criar reservas/solicita√ß√µes

## üîí **SEGURAN√áA E BOAS PR√ÅTICAS**

### **Credenciais:**
- ‚úÖ **Senha de aplicativo** em vez de senha principal
- ‚úÖ **Vari√°veis de ambiente** para credenciais
- ‚úÖ **Nunca commitar** credenciais no c√≥digo
- ‚úÖ **Rotacionar** senhas periodicamente

### **Tratamento de Erros:**
- ‚úÖ **Falha silenciosa** - n√£o quebra o sistema
- ‚úÖ **Logs detalhados** para debugging
- ‚úÖ **N√£o exposi√ß√£o** de dados sens√≠veis
- ‚úÖ **Retry autom√°tico** (se implementado)

### **Performance:**
- ‚úÖ **Envio ass√≠ncrono** - n√£o bloqueia API
- ‚úÖ **Timeout configurado** - evita travamentos
- ‚úÖ **Queue de emails** - se implementado
- ‚úÖ **Rate limiting** - evita spam

## üìà **M√âTRICAS E ESTAT√çSTICAS**

### **O que Monitorar:**
- üìä **Taxa de entrega** de emails
- ‚è±Ô∏è **Tempo de envio** m√©dio
- ‚ùå **Taxa de erro** por tipo
- üìß **Volume** de emails por dia
- üë• **Usu√°rios** que recebem mais notifica√ß√µes

### **Melhorias Futuras:**
- üîÑ **Sistema de retry** para emails falhados
- üìä **Dashboard** de m√©tricas de email
- üéØ **Personaliza√ß√£o** de templates por usu√°rio
- üì± **Notifica√ß√µes push** complementares
- üîî **Prefer√™ncias** de notifica√ß√£o por usu√°rio
